# 安全

## 说明

- 状态：目前处于书写中状态，可能会存在错误或瑕疵，缺少部分图片说明，不建议阅读这个阶段的文本。

## 从 HTTP 到 HTTPS

### HTTP

在信息安全逐步受到重视的大前提下，人们重新审视了 HTTP 协议。

#### HTTP 通信使用明文

基于 TCP/IP 的 HTTP 本身没有加密的功能，所以**没有办法加密通信通道**，这是 HTTP 通信使用明文的核心痛点。

而为了防止被窃听，我们**引入了加密技术**。当然，我们现在知道被广泛使用的就是 HTTPS（HTTP Secure，超文本传输安全协议），我们现在可以简单地认为 **HTTPS = HTTP + SSL（Secure Socket Layer，安全套接层）/TLS（Transport Layer Security，安全层传输协议）**。HTTPS 组合使用 HTTP 和 SSL/TLS，加密了通信通道，使得别人无法窃听通信内容，达到了安全的目的。

如果我们不加密通信通道，我们也可以加密通信内容。但这么做，别人仍然能窃听加密后的通信内容，进而仍然有被篡改的风险。

#### HTTP 协议没有验证通信方的身份

HTTP 不会确认通信方的请求/响应，也就是说**任何人都能发出请求/响应**，这也就带来了一系列问题。

比较常见的隐患有这么几个：

- 没有办法确认服务器是不是目标服务器，有可能是恶意服务器。
- 没有办法确认客户端是不是目标客户端，有可能是恶意客户端。
- 没有办法确认客户端是不是有权限访问特定的内容。
- 没有办法阻止海量请求下的 DoS（Denial of Service，拒绝服务）攻击。

SSL 提供了**证书**这种手段来确认身份。一般来说，证书由值得信赖的第三方机构颁发，它非常难以伪造，用于确认身份。所以，只要确认证书，就可以确认持有证书的所有者身份。

#### HTTP 协议不能证明报文完整正确

HTTP 没有办法确认发出的请求/响应和收到的请求/响应是相同的，所以请求/响应可能会在中途被他人拦截并修改，这也就是中间人攻击（Man-in-the-Middle Attack，MITM）。

可以使用 MD5/SHA-1 等散列值校验的方法、PGP 等数字签名方法来确定完整性，但是需要用户亲自验证，并不便捷，另外也存在 PGP/MD5/... 本身被改写的极端情况，并不安全。

SSL 提供了**认证和加密处理及摘要**功能，有效地解决了这个问题。

### HTTPS

组合使用 HTTP 和通信加密、证书、完整性保护等机制，我们就得到了 HTTPS。

需要再次强调的是，HTTPS 不是应用层的新协议，只是用 SSL/TLS 代替了 HTTP 通信接口部分而已。使用 HTTP 时，HTTP 直接和 TCP/IP 通信。而使用 HTTPS 时，HTTPS 先和 SSL/TLS 通信，再由 SSL/TLS 和 TCP/IP 通信。所以我们上面提到，可以简单地认为 **HTTPS = HTTP + SSL/TLS**。

#### 对称加密和非对称加密

SSL 使用到了非对称加密，这是一种比对称加密更稳妥的加密方式。

对称加密是加解密共用一个密钥的加密方式，算法公开、计算量小、加密速度快、加密效率高。对称加密的问题在于：

- 发送的过程中密钥有可能会被他人窃听，进而丧失加密的意义，但不发送密钥的话对方又无法解密信息。
- 保留密钥需要考虑安全问题。
- 更进一步地说，如果密钥能够安全地发出，那信息也应该能安全地发出，那加密还有什么必要呢？

非对称加密解决了对称加密的几个问题。非对称加密使用了两个密钥：

- 一个称为私钥，请求方自己保留，用于解密响应方返回的已加密的响应信息。
- 另一个称为公钥，请求方公开，响应方用公钥加密响应信息再返回。

这么做就无需担心密钥被窃听进而被用于破解信息，因为发出的密钥只是公钥，而使用公钥成功解密信息的可能性微乎其微，解密成本大大提高，通信双方只需互换公钥就可以实现相对意义上的安全通信。

非对称加密最大的缺点就是处理速度慢，所以从安全和速度两方面考虑，HTTPS 采用了混合加密机制。

#### 混合加密机制

HTTPS 首先会使用非对称加密方式确定共用密钥，然后在通信过程中使用共用密钥进行对称加密。

由于共用密钥被非对称加密后再进行传输，所以即使被人窃听，也难以解密出共用密钥，后续过程再使用共用密钥加密信息、发送信息就相对而言是安全的。

#### 证书和数字签名

混合加密机制也并非无懈可击，破绽就在于公钥上，怎么证明拿到的用于非对称加密的公钥是真的呢？也就是说，怎么证明正在通信的服务器就是目标服务器呢？

这就需要数字证书认证机构（CA，Certificate Authority）和相关机构颁发的服务器公钥证书了。客户端和服务器都认可并信赖 CA，这是服务器公钥证书起作用的前提。

服务器的运营人员会向 CA 申请公钥证书，CA 判明身份无误后，会对服务器公钥做处理，然后把处理后的服务器公钥和证书绑定到一起，给到运营人员手上。

运营人员配置好服务器公钥证书后，服务器会把这个证书发送给客户端以进行非对称加密通信，收到证书的客户端会使用 CA 的公钥验证证书上的数字签名，确认无误后就能确定两件事情：

- 证书真实有效。
- 服务器的公钥真实有效。

但这里还有一个套娃问题，怎么确定 CA 的公钥真实有效？服务器的公钥由 CA 证书证明真实性和有效性，那 CA 的公钥呢？事实上，客户端基本都内置了常见 CA 的公钥，这一点无需过多担心。

这里另外再说一下，CA 对服务器公钥做的处理，就是数字签名。CA 会使用 CA 私钥对服务器公钥进行签名，使用 CA 公钥就可以验证这个签名。

上面提到的证书，是证明公钥真实有效的证书，但证书不只有这一种，我们还可能会见到证明组织真实性的 EV SSL 证书，用于确认服务器背后运营的企业是不是真的存在。这种证书的目的是防止钓鱼攻击，但实际上并没有起到很好的效果。

除了服务器有证书，客户端也可以有证书，作用和服务器证书一样，证明正在通信的客户端就是目标客户端。但客户端证书应用很少，一般会用于银行业，主要有以下几个问题：

- 用户需要手动安装客户端证书。
- 客户端证书大多数需要付费购买。
- 客户端证书只能证明客户端真实存在，不能证明使用者真实有效。

还有一个比较常见的证书，那就是自签名证书，也就是自己给自己颁发的证书。这种证书多用于苹果设备需要使用特殊工具时，比如爱思助手。只要安装了自签名证书，苹果设备就会认可、允许安装应用。

最后还需要强调的一点是，服务器证书生效的前提是：CA 值得信赖。如果 CA 被入侵，证书就变成了黑客的通行证。尽管还存在着 CRL（Certificate Revocation List，证书吊销列表）和 RCA（Root Certificate Authority，根数字证书认证机构，客户端可以删除根数字证书颁发机构使得对应的数字证书无效）机制作为应对，但生效也需要一段时间，而在这段时间内，黑客还是可以搞一些破坏的。

### 安全通信机制

## XSS

## SQL 注入

## CSRF/SSRF

## 文件上传漏洞

## 参考

- 上野宣 - 图解 HTTP

待补充，催稿可以

（1）邮件催稿

（2）打赏，备注“催稿+内容”（通常这种方式会更有效点，毕竟收了钱不好意思再拖，打了钱就不要再打啦，我会加油写的）

<Vssue />
